import streamlit as st
import pandas as pd
import plotly.express as px
import os

# --- ุฅุนุฏุงุฏุงุช ุฎุงุตุฉ ุจุงูุตูุญุฉ (ููุณุช ูุทููุจุฉ ูู ูู ุตูุญุฉ ูููู ูููู ุงุณุชุฎุฏุงููุง) ---
# st.set_page_config(page_title="ุฑุณู ุจูุงูู ุฏุงุฆุฑู", page_icon="๐ฅง")
# ุงูุนููุงู ุงูุฑุฆูุณู ูุฌุจ ุฃู ูููู ูุฑุฉ ูุงุญุฏุฉ ููุท ูู ูู ุตูุญุฉ
st.title("๐ ุชุญููู ุงูุฑุณูู ุงูุฏุงุฆุฑูุฉ")
st.markdown("---")

# ุนุฑุถ ุงููุณุงุฑ ุงูุญุงูู ูููู ุงูุชุทุจูู ูุงููุฌูุฏ ุงูุฐู ูุชูุงุฌุฏ ููู
st.info(f"ุงููุณุงุฑ ุงููุงูู ูููู ุงูุชุทุจูู (`app.py`): **`{os.path.abspath(__file__)}`**")
app_directory = os.path.dirname(os.path.abspath(__file__))
# ููุงุญุธุฉ: `app_directory` ููุง ุณูุดูุฑ ุฅูู ูุฌูุฏ `pages`.
# ูุฌุจ ุฃู ูุนูุฏ ุฎุทูุฉ ููุฎูู ูููุตูู ุฅูู ูููุงุช CSV ูู ุงููุฌูุฏ ุงูุฑุฆูุณู.
data_directory = os.path.abspath(os.path.join(app_directory, os.pardir))
st.info(f"ูุฌูุฏ ุงูุจูุงูุงุช (ุงููุชููุน ููููุงุช CSV): **`{data_directory}`**")
st.warning("ุชุฃูุฏ ุฃู ุฌููุน ูููุงุช CSV ููุฌูุฏุฉ ูู ูุฐุง ุงููุณุงุฑ ูุชุฌูุจ ุงูุฃุฎุทุงุก.")


# --- ูุงุฆูุฉ ุงูุณููุงุช ุงููุชุงุญุฉ ---
years = list(range(2020, 2026))

# --- ุงููุงุฌูุฉ ุงูุฌุงูุจูุฉ (Sidebar) ---
# ูู ุชุทุจููุงุช ุงูุตูุญุงุช ุงููุชุนุฏุฏุฉุ ุงูุดุฑูุท ุงูุฌุงูุจู ูุดุชุฑู ุจูู ุงูุตูุญุงุช
# ูุฐุง ููุถู ูุถุน ุนูุงุตุฑ ุงูุชุญูู ูู ุงูุดุฑูุท ุงูุฌุงูุจู ูู ููู `app.py` ุงูุฑุฆูุณู
# ุฃู ุชูุฑุงุฑูุง ูู ูู ุตูุญุฉ ุฅุฐุง ูุงูุช ุฎุงุตุฉ ุจูุง.
# ููู ูู ูุฐู ุงูุญุงูุฉุ ุณูุถุน ุงูุชุญูู ุจุงูุณูุฉ ููุง ูุฃู ูู ุตูุญุฉ ุณุชุนุฑุถ ููุณ ุงูุจูุงูุงุช.
selected_year = st.sidebar.radio(
    "ุงุฎุชุฑ ุณูุฉ ูุนุฑุถ ุจูุงูุงุชูุง:",
    years,
    key="pie_chart_year_selector" # ูุฌุจ ุฃู ูููู ูู ููุชุงุญ ูุฑูุฏ
)

# --- ุงูููุทูุฉ ุงูุฑุฆูุณูุฉ ูุนุฑุถ ุงูุจูุงูุงุช ---
st.subheader(f"ุงูุจูุงูุงุช ููุณูุฉ: {selected_year}")

# ุงุณู ุงูููู ุงููุชููุน
csv_file_name = f"{selected_year}.csv"
# ูุฏูุฌ ูุฌูุฏ ุงูุจูุงูุงุช (ุงููุฌูุฏ ุงูุฑุฆูุณู) ูุน ุงุณู ุงูููู ูุชุดููู ุงููุณุงุฑ ุงููุงูู
full_file_path = os.path.join(data_directory, csv_file_name)

# ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูููู ููุฌูุฏูุง ุจุงุณุชุฎุฏุงู ุงููุณุงุฑ ุงููุงูู
if os.path.exists(full_file_path):
    try:
        # ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ููู CSV ุจุงุณุชุฎุฏุงู ุงููุณุงุฑ ุงููุงูู
        df = pd.read_csv(full_file_path)

        # ุงูุชุญูู ูู ุฃู DataFrame ููุณ ูุงุฑุบุงู ูุจู ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
        if not df.empty and 'Category' in df.columns and 'Value' in df.columns:
            st.write("ุชู ูุฑุงุกุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ:")
            st.dataframe(df) # ูุนุฑุถ ุฌุฏูู ุงูุจูุงูุงุช

            # --- ุฅูุดุงุก Pie Chart ุชูุงุนูู ุจุงุณุชุฎุฏุงู Plotly ---
            st.subheader("ุชูุฒูุน ุงูุจูุงูุงุช ุงูุชูุงุนูู (Pie Chart)")
            fig = px.pie(df,
                         names='Category',
                         values='Value',
                         title=f"ุชูุฒูุน ุงูุจูุงูุงุช ูู {selected_year}",
                         hole=0.3,
                         hover_data=['Value'])
            fig.update_traces(textposition='inside', textinfo='percent+label')
            fig.update_layout(uniformtext_minsize=12, uniformtext_mode='hide')
            st.plotly_chart(fig, use_container_width=True)

        else:
            st.warning(f"ุงูููู '{csv_file_name}' ูุง ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุชููุนุฉ ุฃู ุงูุฃุนูุฏุฉ 'Category' ู 'Value'.")

    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุฃู ูุนุงูุฌุฉ ุงูููู '{csv_file_name}': {e}")
else:
    st.error(f"ููู ุงูุจูุงูุงุช ููุณูุฉ {selected_year} ({csv_file_name}) ุบูุฑ ููุฌูุฏ ูู ุงููุณุงุฑ: `{full_file_path}`.")
    st.info("ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ูุฌูุฏ ููู CSV ููู ุณูุฉ ูู ููุณ ุงููุฌูุฏ ุงูุฐู ูุนูู ููู ุงูุชุทุจูู (ุงููุฌูุฏ ุงูุฑุฆูุณู).")

st.markdown("---")
st.write("ููุชููู ุจูู ุงูุฑุณูู ุงูุจูุงููุฉุ ุงุณุชุฎุฏู ุงูุดุฑูุท ุงูุฌุงูุจู.")